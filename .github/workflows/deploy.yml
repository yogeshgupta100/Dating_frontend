name: Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          script: |
            # Load environment and find correct paths
            export PATH="/usr/local/bin:/usr/bin:/bin:$PATH"
            source ~/.bashrc 2>/dev/null || true
            source ~/.profile 2>/dev/null || true
            source ~/.nvm/nvm.sh 2>/dev/null || true

            # Find npm and pm2 paths
            NPM_PATH=$(which npm 2>/dev/null || echo "/usr/bin/npm")
            PM2_PATH=$(which pm2 2>/dev/null || echo "/usr/bin/pm2")

            echo "ğŸ“ Using npm at: $NPM_PATH"
            echo "ğŸ“ Using pm2 at: $PM2_PATH"

            echo "ğŸ“ Changing to project directory..."
            cd Dating_frontend/

            echo "ğŸ“¥ Pulling latest changes..."
            git pull origin main

            echo "ğŸ“¦ Installing dependencies..."
            $NPM_PATH ci

            echo "ğŸ”¨ Building application..."
            $NPM_PATH run build

            echo "ğŸ”„ Restarting services..."
            sudo systemctl restart nginx
            $PM2_PATH restart next-frontend

            echo "âœ… Deployment completed successfully!"
